{"version":3,"sources":["../src/cal_heatmap_ctrl.js"],"names":["TimeSeries","MetricsPanelCtrl","moment","kbn","CalHeatMapCtrl","$scope","$element","$injector","subDomains","panelDefaults","datasource","config","animationDuration","domain","subDomain","verticalOrientation","colLimit","rowLimit","cellSize","cellPadding","cellRadius","domainGutter","label","position","rotate","width","legendStr","legendColors","min","max","empty","base","displayLegend","hoverUnitFormat","hoverDecimals","_","defaults","panel","angular","copy","seriesList","setUnitFormat","value","element","events","on","onRender","bind","onDataReceived","onDataError","onDataSnapshotLoad","onInitEditMode","seriesData","index","datapoints","alias","target","series","color","unit","length","last","utc","datapointsCount","data","cells","unitLen","tzOffset","Date","getTimezoneOffset","to_i","t","getDay","x","y","parseFloat","isNaN","i","parseInt","count","sum","sumsq","Infinity","Math","avg","sd","sqrt","thresh","addEditorTab","unitFormats","getUnitFormats","options","decimals","valueFormats","name","String","replace","subItem","itemName","subDomainTitleFormat","filled","format","formatValue","connector","date","legendTitleFormat","lower","upper","inner","down","up","render","elem","elemWidth","elemHeight","height","widthDomains","heightDomains","startsWith","totalPadding","widthPxOffset","range","heightPxOffset","maxPossibleCellWidth","floor","maxPossibleCellHeight","snapshotData","err","dataList","map","seriesHandler","timestamps","stdTimezoneOffset","jan","getFullYear","jul","offset","results","timestamp","cand","indexOf","selectorElem","find","update","points","dashboard","getTimezone","from","add","utcOffset","to","days","diff","cal","CalHeatMap","itemSelector","onClick","start","toDate","domainLabelFormat","afterLoadData","subDomainDateFormat","getAutoCellSize","legend","calcThresholds","split","init","destroy","e","console","log","innerHTML","template","linkTemplate","duration","url","location","href","templateUrl"],"mappings":"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","file":"cal_heatmap_ctrl.js","sourcesContent":["import TimeSeries from 'app/core/time_series2';\nimport {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport moment from 'moment';\nimport kbn from 'app/core/utils/kbn';\nimport './bower_components/d3/d3.js';\nimport './bower_components/cal-heatmap/cal-heatmap.js';\n\nexport class CalHeatMapCtrl extends MetricsPanelCtrl {\n  constructor($scope, $element, $injector) {\n    super($scope, $injector);\n\n    this.subDomains = {\n      'auto':  ['auto'],\n      'month': ['auto', 'day', 'x_day', 'week', 'x_week'],\n      'day':   ['auto', 'hour', 'x_hour'],\n      'hour':  ['auto', 'min', 'x_min']\n    };\n\n    var panelDefaults = {\n      datasource: null,\n      config: {\n        animationDuration: 0,\n        domain: 'auto',\n        subDomain: 'auto',\n        verticalOrientation: false,\n        colLimit: null,\n        rowLimit: null,\n        cellSize: 10,\n        cellPadding: 2,\n        cellRadius: 0,\n        domainGutter: 2,\n        label: {\n          position: 'bottom',\n          rotate: 'null',\n          width: 60,\n        },\n        legendStr: '',\n        legendColors: {\n          min: \"#666\",\n          max: \"steelblue\",\n          empty: \"#222\",\n          base: \"transparent\",\n        },\n        displayLegend: true,\n        hoverUnitFormat: 'short',\n        hoverDecimals: 2,\n      },\n    };\n\n    _.defaults(this.panel, angular.copy(panelDefaults));\n    this.seriesList = [];\n    this.setUnitFormat({value: this.panel.config.hoverUnitFormat || 'short'});\n\n    this.element = $element;\n    this.events.on('render', this.onRender.bind(this));\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('data-error', this.onDataError.bind(this));\n    this.events.on('data-snapshot-load', this.onDataSnapshotLoad.bind(this));\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n  }\n\n  seriesHandler(seriesData, index) {\n    var datapoints = seriesData.datapoints;\n    var alias = seriesData.target;\n\n    var series = new TimeSeries({\n      datapoints: datapoints,\n      alias: alias,\n      color: index,\n      unit: false,\n    });\n\n    if (datapoints && datapoints.length > 0) {\n      var last = moment.utc(datapoints[datapoints.length - 1][1]);\n\n      this.datapointsCount += datapoints.length;\n    }\n\n    return series;\n  }\n\n  calcThresholds(data, subDomain) {\n    var cells = {}; // emulate Cal-HeatMap's cell splitter\n    var unitLen = {};\n    var tzOffset = (new Date()).getTimezoneOffset() * 60;\n\n    var to_i;\n    if (subDomain == 'week')\n      to_i = t => t - t % (24*60*60) - (new Date(t * 1000)).getDay() * (24*60*60);\n    else if (subDomain == 'day')\n      to_i = t => t - t % (24*60*60);\n    else if (subDomain == 'hour')\n      to_i = t => t - t % (60*60);\n    else if (subDomain == 'min')\n      to_i = t => t - t % 60;\n    else\n      throw \"Invalid subDomain in calcThresholds()\";\n\n    for (var x in data) {\n      var y = parseFloat(data[x]);\n      if (isNaN(y))\n        continue;\n      var i = to_i(parseInt(x) + tzOffset);\n      if (cells[i])\n        cells[i] += y;\n      else\n        cells[i] = y;\n    }\n\n    var [count, sum, sumsq, min, max] = [0, 0, 0, Infinity, -Infinity];\n    for (var x in cells) {\n      var y = parseFloat(cells[x]);\n      if (isNaN(y))\n        continue;\n      count++;\n      sum += y;\n      sumsq += y * y;\n      min = Math.min(min, y);\n      max = Math.max(max, y);\n    }\n    var avg = sum / count;\n    var sd = Math.sqrt((sumsq - avg*avg) / count);\n    var thresh = [];\n    min = Math.max(min, avg - sd*1.5);\n    max = Math.min(max, avg + sd*1.5);\n    for (var i = 0; i < 9; i++)\n      thresh[i] = min + (max - min) / 8 * i;\n    return thresh;\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('Options',\n                      'public/plugins/neocat-cal-heatmap-panel/editor.html',\n                      2);\n    this.unitFormats = kbn.getUnitFormats();\n  }\n\n  formatValue(value, options) {\n    var decimals = this.panel.config.hoverDecimals;\n    decimals = (decimals != null && decimals !== '') ? decimals : 2;\n    return kbn.valueFormats[options.name](\n      String(value).replace(',', ''), decimals, null);\n  }\n\n  setUnitFormat(subItem) {\n    this.panel.config.hoverUnitFormat = subItem.value;\n    this.panel.config.itemName = [subItem.value, subItem.value];\n    this.panel.config.subDomainTitleFormat = {\n      empty: '{date}',\n      filled: {format: options =>\n               this.formatValue(options.count, options) +\n               ' ' + options.connector + ' ' + options.date}\n    };\n    this.panel.config.legendTitleFormat = {\n      lower: {format: options => 'less than ' +\n              this.formatValue(options.min, options)},\n      upper: {format: options => 'more than ' +\n              this.formatValue(options.max, options)},\n      inner: {format: options => 'between ' +\n              this.formatValue(options.down, options) + ' and ' +\n              this.formatValue(options.up, options)}\n    };\n    this.render();\n  }\n\n  getAutoCellSize(config, elem, subDomain) {\n    if (config.verticalOrientation == true || \n        config.colLimit || \n        config.rowLimit) {\n      // pass since Grafana does not have dynamic heights\n      return 10; \n    }\n\n    const elemWidth  = elem.width();\n    const elemHeight = elem.height();\n\n    let widthDomains  = 0;\n    let heightDomains = 0;\n\n    switch (config.domain) {\n      case 'month':\n        switch (subDomain) {\n          case 'week':\n            heightDomains = 1;\n            widthDomains  = 5;\n            break;\n          case 'day':\n            heightDomains = 7;\n            widthDomains  = 5;\n        }\n        break;\n      case 'day':\n        heightDomains = 6;\n        widthDomains  = 4;\n        break;\n      case 'hour':\n        heightDomains = 10;\n        widthDomains  = 6;\n    }\n\n    if (config.subDomain && \n        config.subDomain.startsWith('x_')) {\n      const t       = heightDomains + 1;\n      heightDomains = widthDomains;\n      widthDomains  = t;\n    }\n\n    let totalPadding   = config.cellPadding * 6;\n    let widthPxOffset  = config.range * totalPadding;\n    let heightPxOffset = totalPadding + (heightDomains * 6);\n\n    if (config.displayLegend) {\n      heightPxOffset += 50;\n    }\n\n    widthDomains = config.range * widthDomains + 6;\n    heightDomains = heightDomains + 2;\n\n    const maxPossibleCellWidth  = Math.floor((elemWidth  - widthPxOffset)  / widthDomains);\n    const maxPossibleCellHeight = Math.floor((elemHeight - heightPxOffset) / heightDomains);\n\n    if ((config.displayLegend == true && maxPossibleCellHeight < 10) ||\n         maxPossibleCellHeight <= 5 || \n         maxPossibleCellWidth  <= 5) {\n      return 5;\n    }\n\n    return Math.min(maxPossibleCellWidth, maxPossibleCellHeight);\n  }\n\n  onDataSnapshotLoad(snapshotData) {\n    this.onDataReceived(snapshotData.data);\n  }\n\n  onDataError(err) {\n    this.seriesList = [];\n    this.render([]);\n  }\n\n  onDataReceived(dataList) {\n    this.seriesList = dataList.map(this.seriesHandler.bind(this));\n    this.render(this.seriesList);\n  }\n\n  afterLoadData(timestamps) {\n    const stdTimezoneOffset = date => {\n      const jan = new Date(date.getFullYear(), 0, 1);\n      const jul = new Date(date.getFullYear(), 6, 1);\n      return Math.max(\n        jan.getTimezoneOffset(),\n        jul.getTimezoneOffset()\n      );\n    };\n    const offset = stdTimezoneOffset(new Date()) * 60;\n    let results = {};\n    for (let timestamp in timestamps) {\n      const value = timestamps[timestamp];\n      timestamp = parseInt(timestamp, 10);\n      results[timestamp + offset] = value;\n    };\n    return results;\n  }\n\n  onRender() {\n    if (!this.seriesList || !this.seriesList[0])\n      this.seriesList = [{\"datapoints\":[]}];\n\n    var cand = this.subDomains[this.panel.config.domain];\n    if (!cand || cand.indexOf(this.panel.config.subDomain) < 0)\n      this.panel.config.subDomain = 'auto';\n\n    var selectorElem = this.element.find(\".cal-heatmap-panel\")[0];\n    var elem = this.element;\n\n    var update = function() {\n      if (!this.range) return;\n\n      var data = {};\n      var points = this.seriesList[0].datapoints;\n      // Cal-HeatMap always uses browser timezone\n      var tzOffset = (new Date()).getTimezoneOffset();\n      var offset = this.dashboard.getTimezone() == 'utc' ? tzOffset : 0;\n      for (var i = 0; i < points.length; i++) {\n        data[points[i][1] / 1000 + offset*60] = points[i][0];\n      }\n\n      var from = moment.utc(this.range.from).add(offset, 'minutes').utcOffset(-tzOffset);\n      var to = moment.utc(this.range.to).add(offset, 'minutes').utcOffset(-tzOffset);\n      var days = to.diff(from, \"days\") + 1;\n      var cal = this.cal = new CalHeatMap();\n\n      var config = angular.copy(this.panel.config)\n      config.itemSelector = selectorElem;\n      config.data = data;\n      config.label.position = config.verticalOrientation ? 'left' : 'bottom';\n      config.onClick = this.onClick.bind(this);\n\n      if (config.domain == 'auto') {\n        config.domain = days > 31 ? \"month\" : days > 3 ? \"day\" : \"hour\";\n      }\n      if (config.subDomain == 'auto') {\n        delete config.subDomain;\n      }\n      config.start = from.toDate();\n      if (config.domain == 'month') {\n        config.range = moment(to.format('YYYY-MM')).diff(\n          moment(from.format('YYYY-MM')), \"months\") + 1;\n        config.domainLabelFormat = '%y/%m';\n        config.afterLoadData = this.afterLoadData;\n      }\n      else if (config.domain == 'day') {\n        config.range = moment(to.format('YYYY-MM-DD')).diff(\n          moment(from.format('YYYY-MM-DD')), \"days\") + 1;\n        config.domainLabelFormat = '%m/%d';\n      }\n      else if (config.domain == 'hour') {\n        config.range = moment(to.format('YYYY-MM-DD HH:00')).diff(\n          moment(from.format('YYYY-MM-DD HH:00')), \"hours\") + 1;\n        config.domainLabelFormat = '%d %H:%M';\n      }\n      config.range = Math.min(config.range, 100); // avoid browser hang\n\n      var subDomain = config.subDomain ?\n          config.subDomain.replace('x_', '') : this.subDomains[config.domain][1];\n      config.subDomainDateFormat = {\n        'week': null,\n        'day': '%Y-%m-%d',\n        'hour': '%Y-%m-%d %H:%M',\n        'minute': '%Y-%m-%d %H:%M'\n      }[subDomain];\n\n      if (config.cellSize == null || config.cellSize == 0) {\n        config.cellSize = this.getAutoCellSize(config, elem, subDomain);\n      }\n\n      if (!config.legendStr || config.legendStr == 'auto') {\n        config.legend = this.calcThresholds(data, subDomain);\n      } else {\n        config.legend = config.legendStr ?\n          config.legendStr.split(/\\s*,\\s*/).map(x => parseFloat(x)) : null;\n      }\n\n      this.cal.init(config);\n    }.bind(this);\n\n    if (this.cal) {\n      try {\n        this.cal.destroy(update);\n      } catch (e) {\n        console.log(\"Destroy failed: \" + e);\n        elem.innerHTML = '';\n        update();\n      }\n    } else {\n      update();\n    }\n  }\n\n  onClick(date, value) {\n    var config = this.cal.options;\n    var template = config.linkTemplate;\n    if (!template) return;\n    var tzOffset = (new Date()).getTimezoneOffset();\n    var offset = this.dashboard.getTimezone() == 'utc' ? tzOffset : 0;\n    var subDomain = config.subDomain ?\n        config.subDomain.replace('x_', '') : this.subDomains[config.domain][1];\n    var duration = {'week': 7*24*60*60, 'day': 24*60*60,\n                    'hour': 60*60, 'minute': 60}[subDomain];\n    console.log([config.subDomain, subDomain, duration]);\n    if (!duration) return;\n    var from = date - offset * 60000;\n    var to = from + duration * 1000;\n    var url = template.replace('$ts_from', from).replace('$ts_to', to);\n    console.log(url);\n    location.href = url;\n  }\n\n}\n\nCalHeatMapCtrl.templateUrl = 'module.html';\n"]}